<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>æŠ•ç¥¨ã‚·ã‚¹ãƒ†ãƒ </title>
        <meta name="robots" content="noindex">
        <style>
            body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; box-sizing: border-box; }
            *, *::before, *::after { box-sizing: inherit; }
            .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
            h1 { color: #333; text-align: center; margin-bottom: 30px; }
            .mode-selector { text-align: center; margin-bottom: 30px; }
            .mode-btn { background: #007bff; color: white; padding: 12px 30px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin: 0 10px; transition: background 0.2s; }
            .mode-btn:hover { background: #0056b3; }
            .mode-btn.active { background: #28a745; }
            .admin-login { background: #fff3cd; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ffeaa7; }
            .admin-login input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; margin: 10px 0; }
            .question { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #007bff; }
            .question h3 { margin-top: 0; color: #333; }
            .options { margin: 15px 0; }
            .option { margin: 10px 0; padding: 10px; background: white; border-radius: 5px; border: 2px solid #e9ecef; cursor: pointer; transition: all 0.2s; position: relative; display: block; }
            .option:hover { border-color: #007bff; background: #f8f9ff; }
            .option.voted { background-color: #e9ecef; border-color: #ced4da; cursor: not-allowed; }
            .voter-info { background: #e7f3ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
            .voter-info input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
            button { background: #007bff; color: white; padding: 12px 30px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; transition: background 0.2s; margin: 5px; }
            button:hover { background: #0056b3; }
            button:disabled { background: #6c757d; cursor: not-allowed; }
            .btn-success { background: #28a745; }
            .btn-success:hover { background: #1e7e34; }
            .btn-danger { background: #dc3545; }
            .btn-danger:hover { background: #c82333; }
            .btn-warning { background: #ffc107; color: #212529; }
            .btn-warning:hover { background: #e0a800; }
            .message { padding: 15px; border-radius: 5px; margin: 10px 0; display: none; }
            .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
            .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
            .admin-panel { display: none; }
            .question-form { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
            .question-form input, .question-form textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; margin: 5px 0; }
            .question-form textarea { height: 80px; resize: vertical; }
            .option-input { display: flex; align-items: center; margin: 5px 0; gap: 10px; }
            .option-input input[type="text"] { flex: 1 1 auto; width: 100%; }
            .option-input input[type="radio"] { margin-right: 5px; }
            .question-list { max-height: 400px; overflow-y: auto; }
            .question-item { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #ddd; transition: all 0.3s ease; }
            .question-item.active { border-color: #28a745; background: #f8fff8; }
            .question-item.inactive { border-color: #dc3545; background: #fff5f5; }
            .question-item.broadcasting { border-color: #007bff; box-shadow: 0 0 10px rgba(0, 123, 255, 0.5); border-width: 2px; }
            .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
            .stat-card { background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd; }
            .stat-number { font-size: 2em; font-weight: bold; color: #007bff; }
            .hidden { display: none; }
            .admin-result-item { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; font-size: 14px; }
            .admin-result-bar-container { background: #e9ecef; border-radius: 5px; margin: 2px 0 10px 0; overflow: hidden; }
            .admin-result-bar { background: #007bff; height: 15px; border-radius: 5px; transition: width 0.5s ease; color: white; font-size: 12px; line-height: 15px; text-align: right; padding-right: 5px; }
            /* ã€è¿½åŠ ã€‘çµæœç™ºè¡¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
            .result-control { margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd; }
            .result-control h5 { margin-top: 0; }
            .result-control a { display: inline-block; margin-top: 10px; font-weight: bold; }
            
            @media (max-width: 600px) {
                .options { display: flex; flex-direction: column; }
                .container { padding: 15px; }
                .mode-btn { padding: 10px 15px; font-size: 14px; }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>ğŸ—³ï¸ æŠ•ç¥¨ã‚·ã‚¹ãƒ†ãƒ </h1>
            <div class="mode-selector">
                <button class="mode-btn active" onclick="switchMode('vote')">æŠ•ç¥¨</button>
                <button class="mode-btn" onclick="switchMode('admin')">ç®¡ç†è€…</button>
            </div>

            <div id="vote-mode">
                <div class="voter-info">
                    <h3>ğŸ‘¤ æŠ•ç¥¨è€…æƒ…å ±</h3>
                    <input type="text" id="voterName" placeholder="ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šå±±ç”°å¤ªéƒï¼‰" required />
                </div>
                <div id="questions-container"></div>
                <div class="message success" id="successMessage"></div>
                <div class="message error" id="errorMessage"></div>
                <button onclick="submitVote()" id="voteButton">æŠ•ç¥¨ã™ã‚‹</button>
            </div>

            <div id="admin-mode" class="hidden">
                <div class="admin-login" id="admin-login">
                    <h3>ğŸ” ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h3>
                    <input type="password" id="adminPassword" placeholder="ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" />
                    <button onclick="adminLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
                </div>
                <div class="admin-panel" id="admin-panel">
                    <h3>ğŸ“ å•é¡Œç®¡ç†</h3>
                    <div class="question-form">
                        <button onclick="setCurrentQuestion(null)" class="btn-danger">ç¾åœ¨ã®å‡ºé¡Œã‚’åœæ­¢</button>
                    </div>
                    <div class="question-form">
                        <h4>æ–°ã—ã„å•é¡Œã‚’ä½œæˆ</h4>
                        <input type="text" id="newQuestionTitle" placeholder="å•é¡Œã‚¿ã‚¤ãƒˆãƒ«" />
                        <textarea id="newQuestionDescription" placeholder="å•é¡Œã®èª¬æ˜ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰"></textarea>
                        <div id="options-container">
                            <div class="option-input"><input type="text" placeholder="é¸æŠè‚¢1" id="option0" /><input type="radio" name="correctAnswer" value="0" /> æ­£è§£</div>
                            <div class="option-input"><input type="text" placeholder="é¸æŠè‚¢2" id="option1" /><input type="radio" name="correctAnswer" value="1" /> æ­£è§£</div>
                        </div>
                        <button onclick="addOption()" class="btn-success">é¸æŠè‚¢è¿½åŠ </button>
                        <button onclick="removeOption()" class="btn-danger">é¸æŠè‚¢å‰Šé™¤</button>
                        <button onclick="createQuestion()" class="btn-warning">å•é¡Œä½œæˆ</button>
                    </div>
                    <div class="question-list" id="admin-questions-list"><h4>æ—¢å­˜ã®å•é¡Œ</h4></div>
                    <div id="admin-stats"><h3>ğŸ“Š çµ±è¨ˆæƒ…å ±</h3><div class="stats-grid" id="stats-container"></div></div>
                    <button onclick="adminLogout()" class="btn-danger">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>
            </div>
        </div>

        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
        <script>
            const firebaseConfig = {
                apiKey: "AIzaSyA0G-ZXD_90Tk698OzmDmDSObURkxgmsEE",
                authDomain: "kekki-c7090.firebaseapp.com",
                databaseURL: "https://kekki-c7090-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "kekki-c7090",
                storageBucket: "kekki-c7090.firebasestorage.app",
                messagingSenderId: "6528604747",
                appId: "1:6528604747:web:d1cd3a5e9d6e70a1e48bce",
                measurementId: "G-S44YVP0G3N",
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.database();

            const DEFAULT_PASSWORD = "admin123";
            let currentMode = "vote", isAdminLoggedIn = false, optionCount = 2;
            let questions = [], voters = [], userVotes = {}, currentQuestionId = null;

            // --- Firebaseã¨ã®ãƒ‡ãƒ¼ã‚¿åŒæœŸ ---
            db.ref("state").on("value", (snapshot) => {
                const state = snapshot.val() || {};
                currentQuestionId = state.currentQuestionId;
                if (currentMode === "vote") renderCurrentQuestion();
                if (isAdminLoggedIn) renderAdminQuestions();
            });
            db.ref("questions").on("value", (snapshot) => {
                questions = snapshot.val() || [];
                if (currentMode === "vote") renderCurrentQuestion();
                if (isAdminLoggedIn) { renderAdminQuestions(); renderAdminStats(); }
            });
            db.ref("voters").on("value", (snapshot) => {
                voters = snapshot.val() || [];
                if (isAdminLoggedIn) renderAdminStats();
            });
            db.ref("userVotes").on("value", (snapshot) => {
                userVotes = snapshot.val() || {};
                if (currentMode === "vote") renderCurrentQuestion();
            });

            // --- ãƒ‡ãƒ¼ã‚¿æ“ä½œé–¢æ•° ---
            function saveQuestions(d) { db.ref("questions").set(d); }
            function saveVoters(d) { db.ref("voters").set(d); }
            function saveVotes(d) { db.ref("userVotes").set(d); }
            function setCurrentQuestion(id) { db.ref("state/currentQuestionId").set(id); }
            // ã€è¿½åŠ ã€‘çµæœç™ºè¡¨ã®çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
            function setResultView(viewState) { db.ref('state/resultView').set(viewState); }
            
            function switchMode(mode) {
                currentMode = mode;
                document.querySelectorAll(".mode-btn").forEach((btn) => btn.classList.remove("active"));
                event.target.classList.add("active");
                if (mode === "vote") {
                    document.getElementById("vote-mode").classList.remove("hidden");
                    document.getElementById("admin-mode").classList.add("hidden");
                    renderCurrentQuestion();
                } else {
                    document.getElementById("vote-mode").classList.add("hidden");
                    document.getElementById("admin-mode").classList.remove("hidden");
                    if (!isAdminLoggedIn) {
                        document.getElementById("admin-login").style.display = "block";
                        document.getElementById("admin-panel").style.display = "none";
                    }
                }
            }

            function renderCurrentQuestion() {
                const container = document.getElementById("questions-container");
                container.innerHTML = "";
                if (currentQuestionId === null || currentQuestionId === undefined) {
                    container.innerHTML = "<h3>ç®¡ç†è€…ãŒå•é¡Œã‚’å‡ºé¡Œã™ã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„...</h3>";
                    document.getElementById("voteButton").style.display = "none";
                    return;
                }
                const question = questions.find(q => q && q.id === currentQuestionId);
                if (!question) {
                    container.innerHTML = "<h3>å•é¡Œã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</h3>";
                    document.getElementById("voteButton").style.display = "none";
                    return;
                }
                document.getElementById("voteButton").style.display = "inline-block";
                const questionDiv = document.createElement("div");
                questionDiv.className = "question";
                questionDiv.setAttribute("data-question-id", question.id);
                const titleElement = document.createElement("h3");
                titleElement.textContent = question.title;
                questionDiv.appendChild(titleElement);
                if (question.description) {
                    const descElement = document.createElement("p");
                    descElement.textContent = question.description;
                    questionDiv.appendChild(descElement);
                }
                const voterName = document.getElementById("voterName").value.trim();
                const hasVotedForThis = userVotes[voterName] && userVotes[voterName][question.id] !== undefined;
                const optionsDiv = document.createElement("div");
                optionsDiv.className = "options";
                question.options.forEach((option, index) => {
                    const label = document.createElement("label");
                    label.className = "option";
                    const radio = document.createElement("input");
                    radio.type = "radio";
                    radio.name = `vote-${question.id}`;
                    radio.value = index;
                    if (hasVotedForThis) {
                        radio.disabled = true;
                        label.classList.add("voted");
                        if (userVotes[voterName][question.id] === index) {
                            radio.checked = true;
                            label.style.borderColor = "#007bff";
                        }
                    }
                    const optionText = document.createTextNode(option);
                    label.appendChild(radio);
                    label.appendChild(optionText);
                    optionsDiv.appendChild(label);
                });
                questionDiv.appendChild(optionsDiv);
                container.appendChild(questionDiv);
                if (hasVotedForThis) {
                    showMessage("success", `ã€Œ${question.title}ã€ã«ã¯æŠ•ç¥¨æ¸ˆã¿ã§ã™ã€‚`);
                    document.getElementById("voteButton").disabled = true;
                } else {
                    document.getElementById("voteButton").disabled = false;
                }
            }
            
            function submitVote() {
                const voterName = document.getElementById("voterName").value.trim();
                if (!voterName) return showMessage("error", "ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                if (!currentQuestionId) return showMessage("error", "å‡ºé¡Œä¸­ã®å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                const allVoters = voters || [];
                const question = questions.find(q => q && q.id === currentQuestionId);
                const selectedOption = document.querySelector(`input[name="vote-${question.id}"]:checked`);
                if (!selectedOption) return showMessage("error", "é¸æŠè‚¢ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚");
                const optionIndex = parseInt(selectedOption.value);
                const questionInAll = questions.find((q) => q && q.id === question.id);
                if (!questionInAll.votes) questionInAll.votes = new Array(questionInAll.options.length).fill(0);
                questionInAll.votes[optionIndex]++;
                if (!userVotes[voterName]) userVotes[voterName] = {};
                userVotes[voterName][question.id] = optionIndex;
                saveQuestions(questions);
                saveVotes(userVotes);
                if (!allVoters.includes(voterName)) {
                    allVoters.push(voterName);
                    saveVoters(allVoters);
                }
                showMessage("success", "æŠ•ç¥¨ãŒå®Œäº†ã—ã¾ã—ãŸï¼");
                document.getElementById("voterName").disabled = true;
                renderCurrentQuestion();
            }

            function adminLogin() {
                if (document.getElementById("adminPassword").value === DEFAULT_PASSWORD) {
                    isAdminLoggedIn = true;
                    document.getElementById("admin-login").style.display = "none";
                    document.getElementById("admin-panel").style.display = "block";
                    renderAdminQuestions();
                    renderAdminStats();
                    showMessage("success", "ç®¡ç†è€…ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚");
                } else { showMessage("error", "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚"); }
            }
            function adminLogout() {
                isAdminLoggedIn = false;
                document.getElementById("admin-login").style.display = "block";
                document.getElementById("admin-panel").style.display = "none";
                document.getElementById("adminPassword").value = "";
            }

            function renderAdminQuestions() {
                const container = document.getElementById("admin-questions-list");
                container.innerHTML = "<h4>æ—¢å­˜ã®å•é¡Œ</h4>"; 
                questions.forEach((question) => {
                    if (!question) return; 
                    const questionItem = document.createElement("div");
                    questionItem.className = `question-item ${question.active ? "active" : "inactive"}`;
                    if (question.id === currentQuestionId) questionItem.classList.add("broadcasting");
                    
                    const title = document.createElement("h5");
                    title.textContent = question.title;
                    questionItem.appendChild(title);
                    const statusP = document.createElement("p");
                    statusP.textContent = `çŠ¶æ…‹: ${question.active ? "ã‚¢ã‚¯ãƒ†ã‚£ãƒ–" : "éã‚¢ã‚¯ãƒ†ã‚£ãƒ–"}`;
                    questionItem.appendChild(statusP);
                    
                    const graphContainer = document.createElement("div");
                    graphContainer.style.marginTop = "15px";
                    const questionTotalVotes = question.votes ? question.votes.reduce((a, b) => a + b, 0) : 0;
                    const totalVotesP = document.createElement("p");
                    totalVotesP.textContent = `ç·æŠ•ç¥¨æ•°: ${questionTotalVotes}ç¥¨`;
                    totalVotesP.style.fontWeight = "bold";
                    graphContainer.appendChild(totalVotesP);
                    if (questionTotalVotes > 0) {
                        question.options.forEach((option, idx) => {
                            const count = question.votes ? question.votes[idx] : 0;
                            const percentage = ((count / questionTotalVotes) * 100).toFixed(1);
                            const resultItem = document.createElement("div");
                            resultItem.className = "admin-result-item";
                            const optionSpan = document.createElement("span");
                            optionSpan.textContent = option;
                            if (idx === question.correctAnswer) {
                                optionSpan.textContent += " (æ­£è§£)";
                                optionSpan.style.fontWeight = "bold";
                                optionSpan.style.color = "#28a745";
                            }
                            const countSpan = document.createElement("span");
                            countSpan.textContent = `${count}ç¥¨ (${percentage}%)`;
                            resultItem.appendChild(optionSpan);
                            resultItem.appendChild(countSpan);
                            graphContainer.appendChild(resultItem);
                            const barContainer = document.createElement("div");
                            barContainer.className = "admin-result-bar-container";
                            const resultBar = document.createElement("div");
                            resultBar.className = "admin-result-bar";
                            resultBar.style.width = `${percentage}%`;
                            if(percentage > 15) { resultBar.textContent = `${percentage}%`; }
                            barContainer.appendChild(resultBar);
                            graphContainer.appendChild(barContainer);
                        });
                    } else {
                        const noVotesP = document.createElement("p");
                        noVotesP.textContent = "ã¾ã æŠ•ç¥¨ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
                        noVotesP.style.fontSize = "14px";
                        noVotesP.style.color = "#6c757d";
                        graphContainer.appendChild(noVotesP);
                    }
                    questionItem.appendChild(graphContainer);
                    
                    const btnContainer = document.createElement("div");
                    const broadcastBtn = document.createElement("button");
                    broadcastBtn.textContent = "ã“ã®å•é¡Œã‚’å‡ºé¡Œ";
                    broadcastBtn.className = "btn-success";
                    broadcastBtn.disabled = (question.id === currentQuestionId);
                    broadcastBtn.onclick = () => setCurrentQuestion(question.id);
                    btnContainer.appendChild(broadcastBtn);
                    const toggleBtn = document.createElement("button");
                    toggleBtn.textContent = question.active ? "ç„¡åŠ¹åŒ–" : "æœ‰åŠ¹åŒ–";
                    toggleBtn.className = question.active ? "btn-danger" : "btn-success";
                    toggleBtn.onclick = () => toggleQuestion(question.id);
                    btnContainer.appendChild(toggleBtn);
                    const deleteBtn = document.createElement("button");
                    deleteBtn.textContent = "å‰Šé™¤";
                    deleteBtn.className = "btn-danger";
                    deleteBtn.onclick = () => deleteQuestion(question.id);
                    btnContainer.appendChild(deleteBtn);
                    questionItem.appendChild(btnContainer);

                    // ã€è¿½åŠ ã€‘çµæœç™ºè¡¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«UI
                    if (question.id === currentQuestionId) {
                        const resultControlDiv = document.createElement('div');
                        resultControlDiv.className = 'result-control';
                        resultControlDiv.innerHTML = `
                            <h5>çµæœç™ºè¡¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h5>
                            <button onclick="setResultView(1)">1. é¸æŠè‚¢è¡¨ç¤º</button>
                            <button onclick="setResultView(2)">2. ã‚°ãƒ©ãƒ•è¡¨ç¤º</button>
                            <button onclick="setResultView(3)">3. æ­£è§£è¡¨ç¤º</button>
                            <a href="results.html" target="_blank">ç™ºè¡¨ãƒšãƒ¼ã‚¸ã‚’é–‹ã</a>
                        `;
                        questionItem.appendChild(resultControlDiv);
                    }
                    container.appendChild(questionItem);
                });
            }

            function renderAdminStats() {
                const allVoters = voters || [];
                let totalVotes = 0;
                questions.forEach(q => { if(q && q.votes) totalVotes += q.votes.reduce((a,b) => a+b, 0); });
                const container = document.getElementById("stats-container");
                container.innerHTML = "";
                const createStatCard = (title, number, description) => {
                    const card = document.createElement("div"); card.className = "stat-card";
                    const h5 = document.createElement("h5"); h5.textContent = title; card.appendChild(h5);
                    const statNumber = document.createElement("div"); statNumber.className = "stat-number"; statNumber.textContent = number; card.appendChild(statNumber);
                    const p = document.createElement("p"); p.textContent = description; card.appendChild(p);
                    return card;
                };
                container.appendChild(createStatCard("ç·æŠ•ç¥¨æ•°", totalVotes, "ã™ã¹ã¦ã®å•é¡Œã®åˆè¨ˆæŠ•ç¥¨æ•°"));
                container.appendChild(createStatCard("ç™»éŒ²è€…æ•°", allVoters.length, "æŠ•ç¥¨ã—ãŸãƒ¦ãƒ‹ãƒ¼ã‚¯ãªäººæ•°"));
                container.appendChild(createStatCard("å•é¡Œæ•°", questions.filter((q) => q).length, "ä½œæˆæ¸ˆã¿å•é¡Œ"));
            }

            function addOption() {
                optionCount++;
                const container = document.getElementById("options-container");
                const newOption = document.createElement("div");
                newOption.className = "option-input";
                newOption.innerHTML = `<input type="text" placeholder="é¸æŠè‚¢${optionCount}" id="option${optionCount - 1}" /><input type="radio" name="correctAnswer" value="${optionCount - 1}" /> æ­£è§£`;
                container.appendChild(newOption);
            }
            function removeOption() {
                if (optionCount > 2) {
                    document.getElementById("options-container").lastElementChild.remove();
                    optionCount--;
                }
            }
            function createQuestion() {
                const title = document.getElementById("newQuestionTitle").value.trim();
                if (!title) return showMessage("error", "å•é¡Œã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                const options = [];
                for (let i = 0; i < optionCount; i++) {
                    const optionValue = document.getElementById(`option${i}`).value.trim();
                    if (!optionValue) return showMessage("error", `é¸æŠè‚¢${i + 1}ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
                    options.push(optionValue);
                }
                const correctRadio = document.querySelector('input[name="correctAnswer"]:checked');
                if (!correctRadio) return showMessage("error", "æ­£è§£ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
                const allQuestions = questions;
                const newId = allQuestions.length > 0 ? Math.max(...allQuestions.filter(q => q).map((q) => q.id)) + 1 : 1;
                const newQuestion = { id: newId, title: title, description: document.getElementById("newQuestionDescription").value.trim(), options: options, correctAnswer: parseInt(correctRadio.value), active: true, votes: new Array(options.length).fill(0) };
                const emptyIndex = allQuestions.findIndex(q => q === null);
                if (emptyIndex !== -1) { allQuestions[emptyIndex] = newQuestion; } else { allQuestions.push(newQuestion); }
                saveQuestions(allQuestions);
                document.getElementById("newQuestionTitle").value = "";
                document.getElementById("newQuestionDescription").value = "";
                for (let i = 0; i < optionCount; i++) document.getElementById(`option${i}`).value = "";
                correctRadio.checked = false;
                showMessage("success", "æ–°ã—ã„å•é¡Œã‚’ä½œæˆã—ã¾ã—ãŸã€‚");
            }
            function toggleQuestion(id) {
                const q = questions.find((q) => q && q.id === id);
                if (q) { q.active = !q.active; saveQuestions(questions); }
            }
            function deleteQuestion(id) {
                if (confirm("ã“ã®å•é¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                    const qIndex = questions.findIndex((q) => q && q.id === id);
                    if (qIndex !== -1) {
                        if (currentQuestionId === id) setCurrentQuestion(null);
                        questions[qIndex] = null;
                        saveQuestions(questions);
                    }
                }
            }
            function showMessage(type, message) {
                const el = document.getElementById(type + "Message");
                el.textContent = (type === "success" ? "âœ… " : "âŒ ") + message;
                el.style.display = "block";
                setTimeout(() => { el.style.display = "none"; }, 3000);
            }
        </script>
    </body>
</html>