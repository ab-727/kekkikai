<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>æŠ•ç¥¨ã‚·ã‚¹ãƒ†ãƒ </title>
        <style>
            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                max-width: 1000px;
                margin: 0 auto;
                padding: 20px;
                background-color: #f5f5f5;
            }
            .container {
                background: white;
                padding: 30px;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                margin-bottom: 20px;
            }
            h1 {
                color: #333;
                text-align: center;
                margin-bottom: 30px;
            }
            .mode-selector {
                text-align: center;
                margin-bottom: 30px;
            }
            .mode-btn {
                background: #007bff;
                color: white;
                padding: 12px 30px;
                border: none;
                border-radius: 5px;
                font-size: 16px;
                cursor: pointer;
                margin: 0 10px;
                transition: background 0.2s;
            }
            .mode-btn:hover {
                background: #0056b3;
            }
            .mode-btn.active {
                background: #28a745;
            }
            .admin-login {
                background: #fff3cd;
                padding: 20px;
                border-radius: 8px;
                margin-bottom: 20px;
                border: 1px solid #ffeaa7;
            }
            .admin-login input {
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-size: 16px;
                margin: 10px 0;
            }
            .question {
                background: #f8f9fa;
                padding: 20px;
                border-radius: 8px;
                margin-bottom: 20px;
                border-left: 4px solid #007bff;
            }
            .question h3 {
                margin-top: 0;
                color: #333;
            }
            .options {
                margin: 15px 0;
            }
            .option {
                margin: 10px 0;
                padding: 10px;
                background: white;
                border-radius: 5px;
                border: 2px solid #e9ecef;
                cursor: pointer;
                transition: all 0.2s;
                position: relative;
            }
            .option:hover {
                border-color: #007bff;
                background: #f8f9ff;
            }
            .option input[type="radio"] {
                margin-right: 10px;
            }
            .correct-answer {
                border-color: #28a745;
                background: #f8fff8;
            }
            .correct-indicator {
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                color: #28a745;
                font-weight: bold;
            }
            .voter-info {
                background: #e7f3ff;
                padding: 20px;
                border-radius: 8px;
                margin-bottom: 20px;
            }
            .voter-info input {
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-size: 16px;
            }
            button {
                background: #007bff;
                color: white;
                padding: 12px 30px;
                border: none;
                border-radius: 5px;
                font-size: 16px;
                cursor: pointer;
                transition: background 0.2s;
                margin: 5px;
            }
            button:hover {
                background: #0056b3;
            }
            button:disabled {
                background: #6c757d;
                cursor: not-allowed;
            }
            .btn-success {
                background: #28a745;
            }
            .btn-success:hover {
                background: #1e7e34;
            }
            .btn-danger {
                background: #dc3545;
            }
            .btn-danger:hover {
                background: #c82333;
            }
            .btn-warning {
                background: #ffc107;
                color: #212529;
            }
            .btn-warning:hover {
                background: #e0a800;
            }
            .results {
                margin-top: 30px;
                display: none;
            }
            .result-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px;
                margin: 5px 0;
                background: #f8f9fa;
                border-radius: 5px;
            }
            .result-bar {
                background: #007bff;
                height: 20px;
                border-radius: 10px;
                margin: 5px 0;
                transition: width 0.5s ease;
            }
            .message {
                padding: 15px;
                border-radius: 5px;
                margin: 10px 0;
                display: none;
            }
            .success {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }
            .error {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }
            .admin-panel {
                display: none;
            }
            .question-form {
                background: #f8f9fa;
                padding: 20px;
                border-radius: 8px;
                margin-bottom: 20px;
            }
            .question-form input,
            .question-form textarea {
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-size: 14px;
                margin: 5px 0;
            }
            .question-form textarea {
                height: 80px;
                resize: vertical;
            }
            .option-input {
                display: flex;
                align-items: center;
                margin: 5px 0;
            }
            .option-input input[type="text"] {
                flex: 1;
                margin-right: 10px;
            }
            .option-input input[type="radio"] {
                margin-right: 5px;
            }
            .question-list {
                max-height: 400px;
                overflow-y: auto;
            }
            .question-item {
                background: white;
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 10px;
                border: 1px solid #ddd;
            }
            .question-item.active {
                border-color: #28a745;
                background: #f8fff8;
            }
            .question-item.inactive {
                border-color: #dc3545;
                background: #fff5f5;
            }
            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
                margin-top: 20px;
            }
            .stat-card {
                background: white;
                padding: 20px;
                border-radius: 8px;
                border: 1px solid #ddd;
            }
            .stat-number {
                font-size: 2em;
                font-weight: bold;
                color: #007bff;
            }
            .hidden {
                display: none;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>ğŸ—³ï¸ æŠ•ç¥¨ã‚·ã‚¹ãƒ†ãƒ </h1>

            <div class="mode-selector">
                <button class="mode-btn active" onclick="switchMode('vote')">æŠ•ç¥¨</button>
                <button class="mode-btn" onclick="switchMode('admin')">ç®¡ç†è€…</button>
            </div>

            <!-- æŠ•ç¥¨è€…ãƒ¢ãƒ¼ãƒ‰ -->
            <div id="vote-mode">
                <div class="voter-info">
                    <h3>ğŸ‘¤ æŠ•ç¥¨è€…æƒ…å ±</h3>
                    <input type="text" id="voterName" placeholder="ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šå±±ç”°å¤ªéƒï¼‰" required />
                </div>

                <div id="questions-container">
                    <!-- å‹•çš„ã«å•é¡ŒãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>

                <div class="message success" id="successMessage">âœ… æŠ•ç¥¨ãŒå®Œäº†ã—ã¾ã—ãŸï¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚</div>

                <div class="message error" id="errorMessage">âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</div>

                <button onclick="submitVote()" id="voteButton">æŠ•ç¥¨ã™ã‚‹</button>
                <button onclick="showResults()" class="btn-success">çµæœã‚’è¦‹ã‚‹</button>

                <div class="results" id="results">
                    <h3>ğŸ“Š æŠ•ç¥¨çµæœ</h3>
                    <div id="resultsList"></div>
                    <p style="color: #666; font-size: 14px; margin-top: 20px">ç·æŠ•ç¥¨æ•°: <span id="totalVotes">0</span>ç¥¨</p>
                </div>
            </div>

            <!-- ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ -->
            <div id="admin-mode" class="hidden">
                <div class="admin-login" id="admin-login">
                    <h3>ğŸ” ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h3>
                    <input type="password" id="adminPassword" placeholder="ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" />
                    <button onclick="adminLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
                </div>

                <div class="admin-panel" id="admin-panel">
                    <h3>ğŸ“ å•é¡Œç®¡ç†</h3>

                    <!-- æ–°ã—ã„å•é¡Œä½œæˆ -->
                    <div class="question-form">
                        <h4>æ–°ã—ã„å•é¡Œã‚’ä½œæˆ</h4>
                        <input type="text" id="newQuestionTitle" placeholder="å•é¡Œã‚¿ã‚¤ãƒˆãƒ«" />
                        <textarea id="newQuestionDescription" placeholder="å•é¡Œã®èª¬æ˜ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰"></textarea>

                        <div id="options-container">
                            <div class="option-input">
                                <input type="text" placeholder="é¸æŠè‚¢1" id="option0" />
                                <input type="radio" name="correctAnswer" value="0" /> æ­£è§£
                            </div>
                            <div class="option-input">
                                <input type="text" placeholder="é¸æŠè‚¢2" id="option1" />
                                <input type="radio" name="correctAnswer" value="1" /> æ­£è§£
                            </div>
                        </div>

                        <button onclick="addOption()" class="btn-success">é¸æŠè‚¢è¿½åŠ </button>
                        <button onclick="removeOption()" class="btn-danger">é¸æŠè‚¢å‰Šé™¤</button>
                        <button onclick="createQuestion()" class="btn-warning">å•é¡Œä½œæˆ</button>
                    </div>

                    <!-- æ—¢å­˜å•é¡Œä¸€è¦§ -->
                    <div class="question-list" id="admin-questions-list">
                        <h4>æ—¢å­˜ã®å•é¡Œ</h4>
                        <!-- å‹•çš„ã«å•é¡Œä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </div>

                    <!-- çµ±è¨ˆæƒ…å ± -->
                    <div id="admin-stats">
                        <h3>ğŸ“Š çµ±è¨ˆæƒ…å ±</h3>
                        <div class="stats-grid" id="stats-container">
                            <!-- å‹•çš„ã«çµ±è¨ˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
                        </div>
                    </div>

                    <button onclick="adminLogout()" class="btn-danger">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>
            </div>
        </div>

        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

        <script>
            // For Firebase JS SDK v7.20.0 and later, measurementId is optional
            const firebaseConfig = {
                apiKey: "AIzaSyA0G-ZXD_90Tk698OzmDmDSObURkxgmsEE",
                authDomain: "kekki-c7090.firebaseapp.com",
                databaseURL: "https://kekki-c7090-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "kekki-c7090",
                storageBucket: "kekki-c7090.firebasestorage.app",
                messagingSenderId: "6528604747",
                appId: "1:6528604747:web:d1cd3a5e9d6e70a1e48bce",
                measurementId: "G-S44YVP0G3N",
            };

            // Firebaseã‚’åˆæœŸåŒ–
            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
        </script>

        <script>
            // Firebaseã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å‚ç…§
            const db = firebase.database();

            // åˆæœŸãƒ‡ãƒ¼ã‚¿ã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
            const DEFAULT_PASSWORD = "admin123";
            let currentMode = "vote";
            let isAdminLoggedIn = false;
            let optionCount = 2;

            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°
            let questions = [];
            let voters = [];
            let userVotes = {};

            // --- Firebaseã¨ã®ãƒ‡ãƒ¼ã‚¿åŒæœŸ ---

            // 1. å•é¡Œãƒ‡ãƒ¼ã‚¿ã®åŒæœŸ
            db.ref("questions").on("value", (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    questions = data;
                } else {
                    // DBã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã€åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã‚€
                    const initialQuestions = [
                        {
                            id: 1,
                            title: "ã‚ãªãŸãŒæœ€ã‚‚å¥½ããªãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã¯ï¼Ÿ",
                            description: "",
                            options: ["Python", "JavaScript", "Java", "C++"],
                            correctAnswer: 0,
                            active: true,
                            votes: [0, 0, 0, 0],
                        },
                    ];
                    db.ref("questions").set(initialQuestions);
                }
                // ç”»é¢ã‚’å†æç”»
                if (currentMode === "vote") renderQuestions();
                if (isAdminLoggedIn) {
                    renderAdminQuestions();
                    renderAdminStats();
                }
            });

            // 2. æŠ•ç¥¨è€…ãƒ‡ãƒ¼ã‚¿ã®åŒæœŸ
            db.ref("voters").on("value", (snapshot) => {
                voters = snapshot.val() || [];
                if (isAdminLoggedIn) renderAdminStats();
            });

            // 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®æŠ•ç¥¨è¨˜éŒ²ã®åŒæœŸ
            db.ref("userVotes").on("value", (snapshot) => {
                userVotes = snapshot.val() || {};
            });

            // --- ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½¿ã£ã¦ã„ãŸé–¢æ•°ã‚’Firebaseã‚’ä½¿ã†ã‚ˆã†ã«å¤‰æ›´ ---

            function getQuestions() {
                return questions;
            }

            function getVoters() {
                return voters;
            }

            function getVotes() {
                return userVotes;
            }

            function saveQuestions(newQuestions) {
                db.ref("questions").set(newQuestions);
            }

            function saveVoters(newVoters) {
                db.ref("voters").set(newVoters);
            }

            function saveVotes(newUserVotes) {
                db.ref("userVotes").set(newUserVotes);
            }

            // --- ä»¥ä¸‹ã€æ—¢å­˜ã®é–¢æ•°ï¼ˆã»ã¼å¤‰æ›´ãªã—ï¼‰ ---

            // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
            function switchMode(mode) {
                currentMode = mode;
                document.querySelectorAll(".mode-btn").forEach((btn) => btn.classList.remove("active"));
                event.target.classList.add("active");
                if (mode === "vote") {
                    document.getElementById("vote-mode").classList.remove("hidden");
                    document.getElementById("admin-mode").classList.add("hidden");
                    renderQuestions();
                } else {
                    document.getElementById("vote-mode").classList.add("hidden");
                    document.getElementById("admin-mode").classList.remove("hidden");
                    if (!isAdminLoggedIn) {
                        document.getElementById("admin-login").style.display = "block";
                        document.getElementById("admin-panel").style.display = "none";
                    }
                }
            }

            // ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³
            function adminLogin() {
                const password = document.getElementById("adminPassword").value;
                if (password === DEFAULT_PASSWORD) {
                    isAdminLoggedIn = true;
                    document.getElementById("admin-login").style.display = "none";
                    document.getElementById("admin-panel").style.display = "block";
                    renderAdminQuestions();
                    renderAdminStats();
                    showMessage("success", "ç®¡ç†è€…ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚");
                } else {
                    showMessage("error", "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
                }
            }

            function adminLogout() {
                isAdminLoggedIn = false;
                document.getElementById("admin-login").style.display = "block";
                document.getElementById("admin-panel").style.display = "none";
                document.getElementById("adminPassword").value = "";
            }

            // å•é¡Œè¡¨ç¤ºï¼ˆæŠ•ç¥¨è€…ç”¨ï¼‰
            function renderQuestions() {
                const activeQuestions = getQuestions().filter((q) => q && q.active);
                const container = document.getElementById("questions-container");
                container.innerHTML = ""; // ä»¥å‰ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªã‚¢

                if (activeQuestions.length === 0) {
                    container.innerHTML = "<p>ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
                    return;
                }

                activeQuestions.forEach((question) => {
                    const questionDiv = document.createElement("div");
                    questionDiv.className = "question";
                    questionDiv.setAttribute("data-question-id", question.id);

                    const titleElement = document.createElement("h3");
                    titleElement.textContent = question.title;
                    questionDiv.appendChild(titleElement);

                    if (question.description) {
                        const descElement = document.createElement("p");
                        descElement.textContent = question.description;
                        questionDiv.appendChild(descElement);
                    }

                    const optionsDiv = document.createElement("div");
                    optionsDiv.className = "options";
                    question.options.forEach((option, index) => {
                        const label = document.createElement("label");
                        label.className = "option";
                        const radio = document.createElement("input");
                        radio.type = "radio";
                        radio.name = `vote-${question.id}`;
                        radio.value = index;
                        const optionText = document.createTextNode(option);
                        label.appendChild(radio);
                        label.appendChild(optionText);
                        optionsDiv.appendChild(label);
                    });
                    questionDiv.appendChild(optionsDiv);
                    container.appendChild(questionDiv);
                });
            }

            // ç®¡ç†è€…ç”¨å•é¡Œä¸€è¦§
            function renderAdminQuestions() {
                const allQuestions = getQuestions();
                const container = document.getElementById("admin-questions-list");
                container.innerHTML = "<h4>æ—¢å­˜ã®å•é¡Œ</h4>"; // ã‚¯ãƒªã‚¢ã—ã¦è¦‹å‡ºã—ã‚’è¿½åŠ 

                allQuestions.forEach((question, index) => {
                    // idã®ä»£ã‚ã‚Šã«indexã‚’ä½¿ã†
                    if (!question) return; // å‰Šé™¤ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã¯ã‚¹ã‚­ãƒƒãƒ—

                    const questionItem = document.createElement("div");
                    questionItem.className = `question-item ${question.active ? "active" : "inactive"}`;
                    const title = document.createElement("h5");
                    title.textContent = question.title;
                    questionItem.appendChild(title);

                    const optionsP = document.createElement("p");
                    optionsP.textContent = "é¸æŠè‚¢: " + question.options.join(", ");
                    questionItem.appendChild(optionsP);

                    const correctP = document.createElement("p");
                    correctP.textContent = `æ­£è§£: ${question.options[question.correctAnswer]} (${question.correctAnswer + 1}ç•ªç›®)`;
                    questionItem.appendChild(correctP);

                    const totalVotes = question.votes ? question.votes.reduce((a, b) => a + b, 0) : 0;
                    const votesP = document.createElement("p");
                    votesP.textContent = `æŠ•ç¥¨æ•°: ${totalVotes}ç¥¨`;
                    questionItem.appendChild(votesP);

                    const statusP = document.createElement("p");
                    statusP.textContent = `çŠ¶æ…‹: ${question.active ? "ã‚¢ã‚¯ãƒ†ã‚£ãƒ–" : "éã‚¢ã‚¯ãƒ†ã‚£ãƒ–"}`;
                    questionItem.appendChild(statusP);

                    const toggleBtn = document.createElement("button");
                    toggleBtn.textContent = question.active ? "ç„¡åŠ¹åŒ–" : "æœ‰åŠ¹åŒ–";
                    toggleBtn.className = question.active ? "btn-danger" : "btn-success";
                    toggleBtn.onclick = () => toggleQuestion(question.id);
                    questionItem.appendChild(toggleBtn);

                    const deleteBtn = document.createElement("button");
                    deleteBtn.textContent = "å‰Šé™¤";
                    deleteBtn.className = "btn-danger";
                    deleteBtn.onclick = () => deleteQuestion(question.id);
                    questionItem.appendChild(deleteBtn);

                    container.appendChild(questionItem);
                });
            }

            // çµ±è¨ˆæƒ…å ±è¡¨ç¤º
            function renderAdminStats() {
                const allQuestions = getQuestions();
                const allVoters = getVoters();

                let totalVotes = 0;
                let correctAnswers = 0;
                let questionStats = [];

                allQuestions.forEach((question) => {
                    if (!question) return;
                    const questionVotes = question.votes ? question.votes.reduce((a, b) => a + b, 0) : 0;
                    totalVotes += questionVotes;

                    const correctVotes = question.votes ? question.votes[question.correctAnswer] : 0;
                    correctAnswers += correctVotes;

                    const accuracy = questionVotes > 0 ? ((correctVotes / questionVotes) * 100).toFixed(1) : 0;

                    questionStats.push({
                        title: question.title,
                        totalVotes: questionVotes,
                        correctVotes: correctVotes,
                        accuracy: accuracy,
                    });
                });

                const overallAccuracy = totalVotes > 0 ? ((correctAnswers / totalVotes) * 100).toFixed(1) : 0;

                const container = document.getElementById("stats-container");
                container.innerHTML = ""; // ã‚¯ãƒªã‚¢

                const createStatCard = (title, number, description) => {
                    const card = document.createElement("div");
                    card.className = "stat-card";
                    const h5 = document.createElement("h5");
                    h5.textContent = title;
                    card.appendChild(h5);
                    const statNumber = document.createElement("div");
                    statNumber.className = "stat-number";
                    statNumber.textContent = number;
                    card.appendChild(statNumber);
                    const p = document.createElement("p");
                    p.textContent = description;
                    card.appendChild(p);
                    return card;
                };

                container.appendChild(createStatCard("å…¨ä½“çµ±è¨ˆ", totalVotes, "ç·æŠ•ç¥¨æ•°"));
                container.appendChild(createStatCard("ç™»éŒ²è€…æ•°", allVoters.length, "æŠ•ç¥¨è€…"));
                container.appendChild(createStatCard("å…¨ä½“æ­£ç­”ç‡", `${overallAccuracy}%`, "æ­£è§£ç‡"));
                container.appendChild(createStatCard("å•é¡Œæ•°", allQuestions.filter((q) => q).length, "ä½œæˆæ¸ˆã¿å•é¡Œ"));

                questionStats.forEach((stat) => {
                    const card = document.createElement("div");
                    card.className = "stat-card";
                    const h5 = document.createElement("h5");
                    h5.textContent = stat.title;
                    card.appendChild(h5);
                    const statNumber = document.createElement("div");
                    statNumber.className = "stat-number";
                    statNumber.textContent = `${stat.accuracy}%`;
                    card.appendChild(statNumber);
                    const p = document.createElement("p");
                    p.textContent = `æ­£ç­”ç‡ (${stat.correctVotes}/${stat.totalVotes})`;
                    card.appendChild(p);
                    container.appendChild(card);
                });
            }

            // é¸æŠè‚¢è¿½åŠ ãƒ»å‰Šé™¤
            function addOption() {
                optionCount++;
                const container = document.getElementById("options-container");
                const newOption = document.createElement("div");
                newOption.className = "option-input";
                const textInput = document.createElement("input");
                textInput.type = "text";
                textInput.placeholder = `é¸æŠè‚¢${optionCount}`;
                textInput.id = `option${optionCount - 1}`;
                const radioInput = document.createElement("input");
                radioInput.type = "radio";
                radioInput.name = "correctAnswer";
                radioInput.value = optionCount - 1;
                const labelText = document.createTextNode(" æ­£è§£");
                newOption.appendChild(textInput);
                newOption.appendChild(radioInput);
                newOption.appendChild(labelText);
                container.appendChild(newOption);
            }

            function removeOption() {
                if (optionCount > 2) {
                    const container = document.getElementById("options-container");
                    container.removeChild(container.lastElementChild);
                    optionCount--;
                }
            }

            // å•é¡Œä½œæˆ
            function createQuestion() {
                const title = document.getElementById("newQuestionTitle").value.trim();
                if (!title) return showMessage("error", "å•é¡Œã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");

                const options = [];
                for (let i = 0; i < optionCount; i++) {
                    const optionValue = document.getElementById(`option${i}`).value.trim();
                    if (!optionValue) return showMessage("error", `é¸æŠè‚¢${i + 1}ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
                    options.push(optionValue);
                }

                const correctRadio = document.querySelector('input[name="correctAnswer"]:checked');
                if (!correctRadio) return showMessage("error", "æ­£è§£ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");

                const allQuestions = getQuestions();
                const newQuestion = {
                    id: allQuestions.length > 0 ? Math.max(...allQuestions.map((q) => q.id)) + 1 : 1,
                    title: title,
                    description: document.getElementById("newQuestionDescription").value.trim(),
                    options: options,
                    correctAnswer: parseInt(correctRadio.value),
                    active: true,
                    votes: new Array(options.length).fill(0),
                };

                allQuestions.push(newQuestion);
                saveQuestions(allQuestions);

                // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
                document.getElementById("newQuestionTitle").value = "";
                document.getElementById("newQuestionDescription").value = "";
                for (let i = 0; i < optionCount; i++) document.getElementById(`option${i}`).value = "";
                correctRadio.checked = false;

                showMessage("success", "æ–°ã—ã„å•é¡Œã‚’ä½œæˆã—ã¾ã—ãŸã€‚");
            }

            // å•é¡Œã®æœ‰åŠ¹åŒ–ãƒ»ç„¡åŠ¹åŒ–
            function toggleQuestion(questionId) {
                const allQuestions = getQuestions();
                const question = allQuestions.find((q) => q && q.id === questionId);
                if (question) {
                    question.active = !question.active;
                    saveQuestions(allQuestions);
                }
            }

            // å•é¡Œå‰Šé™¤
            function deleteQuestion(questionId) {
                if (confirm("ã“ã®å•é¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                    let allQuestions = getQuestions();
                    // Firebaseã§ã¯é…åˆ—ã®è¦ç´ ã‚’ç›´æ¥å‰Šé™¤ã™ã‚‹ã‚ˆã‚Šã€nullã§ä¸Šæ›¸ãã™ã‚‹ã®ãŒç°¡å˜
                    const questionIndex = allQuestions.findIndex((q) => q && q.id === questionId);
                    if (questionIndex !== -1) {
                        allQuestions[questionIndex] = null;
                    }
                    saveQuestions(allQuestions);
                }
            }

            // æŠ•ç¥¨å‡¦ç†
            function submitVote() {
                const voterName = document.getElementById("voterName").value.trim();
                if (!voterName) return showMessage("error", "ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");

                const allVoters = getVoters();
                if (allVoters.includes(voterName)) return showMessage("error", "ã“ã®ãŠåå‰ã¯æ—¢ã«æŠ•ç¥¨æ¸ˆã¿ã§ã™ã€‚");

                const activeQuestions = getQuestions().filter((q) => q && q.active);
                const currentUserVotes = getVotes();
                const allQuestions = getQuestions();

                let hasVoted = false;
                activeQuestions.forEach((question) => {
                    const selectedOption = document.querySelector(`input[name="vote-${question.id}"]:checked`);
                    if (selectedOption) {
                        const optionIndex = parseInt(selectedOption.value);
                        const questionInAll = allQuestions.find((q) => q && q.id === question.id);
                        if (!questionInAll.votes) {
                            // å¿µã®ãŸã‚åˆæœŸåŒ–
                            questionInAll.votes = new Array(questionInAll.options.length).fill(0);
                        }
                        questionInAll.votes[optionIndex]++;

                        if (!currentUserVotes[voterName]) currentUserVotes[voterName] = {};
                        currentUserVotes[voterName][question.id] = optionIndex;
                        hasVoted = true;
                    }
                });

                if (!hasVoted) return showMessage("error", "å°‘ãªãã¨ã‚‚1ã¤ã®å•é¡Œã«å›ç­”ã—ã¦ãã ã•ã„ã€‚");

                saveQuestions(allQuestions);
                saveVotes(currentUserVotes);
                allVoters.push(voterName);
                saveVoters(allVoters);

                showMessage("success", "æŠ•ç¥¨ãŒå®Œäº†ã—ã¾ã—ãŸï¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚");
                document.getElementById("voteButton").disabled = true;
                document.getElementById("voterName").disabled = true;
                document.querySelectorAll('input[type="radio"]').forEach((input) => (input.disabled = true));

                setTimeout(() => showResults(), 1500);
            }

            // çµæœè¡¨ç¤º
            function showResults() {
                const activeQuestions = getQuestions().filter((q) => q && q.active);
                const resultsDiv = document.getElementById("results");
                const resultsListDiv = document.getElementById("resultsList");

                if (activeQuestions.length === 0) return showMessage("error", "ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚");

                let totalVotes = 0;
                resultsListDiv.innerHTML = "";

                activeQuestions.forEach((question) => {
                    const questionTotalVotes = question.votes ? question.votes.reduce((sum, count) => sum + count, 0) : 0;
                    totalVotes += questionTotalVotes;

                    const questionTitle = document.createElement("h4");
                    questionTitle.textContent = question.title;
                    resultsListDiv.appendChild(questionTitle);

                    question.options.forEach((option, index) => {
                        const count = question.votes ? question.votes[index] : 0;
                        const percentage = questionTotalVotes > 0 ? ((count / questionTotalVotes) * 100).toFixed(1) : 0;

                        const resultItem = document.createElement("div");
                        resultItem.className = "result-item";

                        const optionSpan = document.createElement("span");
                        const strongEl = document.createElement("strong");
                        strongEl.textContent = option;
                        optionSpan.appendChild(strongEl);

                        const countSpan = document.createElement("span");
                        countSpan.textContent = `${count}ç¥¨ (${percentage}%)`;

                        resultItem.appendChild(optionSpan);
                        resultItem.appendChild(countSpan);

                        const resultBar = document.createElement("div");
                        resultBar.className = "result-bar";
                        resultBar.style.width = `${percentage}%`;

                        resultsListDiv.appendChild(resultItem);
                        resultsListDiv.appendChild(resultBar);
                    });
                });

                document.getElementById("totalVotes").textContent = totalVotes;
                resultsDiv.style.display = "block";
            }

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            function showMessage(type, message) {
                document.getElementById("successMessage").style.display = "none";
                document.getElementById("errorMessage").style.display = "none";

                const messageElement = document.getElementById(type + "Message");
                messageElement.textContent = (type === "success" ? "âœ… " : "âŒ ") + message;
                messageElement.style.display = "block";

                setTimeout(() => {
                    messageElement.style.display = "none";
                }, 3000);
            }

            // åˆæœŸåŒ–
            window.onload = function () {
                // Firebaseã®on()ãŒè‡ªå‹•ã§æç”»ã™ã‚‹ã®ã§ã€ã“ã“ã§ã®å‘¼ã³å‡ºã—ã¯ä¸è¦ã«ãªã‚‹ã“ã¨ãŒå¤šã„
                // ã‚‚ã—åˆæœŸè¡¨ç¤ºãŒã†ã¾ãã„ã‹ãªã„å ´åˆã¯ã€ä»¥ä¸‹ã®è¡Œã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¤–ã™
                // renderQuestions();
            };
        </script>
    </body>
</html>
